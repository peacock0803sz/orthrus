name: "Auto-merge PRs made by dependabot"
on:
  pull_request_target:

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    defaults:
      run:
        shell: bash
    steps:
      - id: metadata
        uses: dependabot/fetch-metadata@08eff52bf64351f401fb50d4972fa95b9f2c2d1b # v2.4.0
        continue-on-error: true
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Wait for CI checks to complete
        if: steps.metadata.outcome == 'success' && (steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor')
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const sha = context.payload.pull_request.head.sha;
            const currentWorkflow = 'Auto-merge PRs made by dependabot';
            const maxAttempts = 60;
            const interval = 10000; // 10 seconds

            for (let attempt = 0; attempt < maxAttempts; attempt++) {
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: sha,
              });

              // 自身のワークフロー以外のチェックをフィルタリング
              const otherChecks = checkRuns.check_runs.filter(
                (check) => !check.name.includes(currentWorkflow) && check.name !== 'auto-merge'
              );

              if (otherChecks.length === 0) {
                core.info('No other checks found, proceeding...');
                return;
              }

              const pending = otherChecks.filter(
                (check) => check.status !== 'completed'
              );
              const failed = otherChecks.filter(
                (check) => check.status === 'completed' && check.conclusion !== 'success' && check.conclusion !== 'skipped'
              );

              if (failed.length > 0) {
                const failedNames = failed.map((c) => c.name).join(', ');
                core.setFailed(`CI checks failed: ${failedNames}`);
                return;
              }

              if (pending.length === 0) {
                core.info('All CI checks passed!');
                return;
              }

              const pendingNames = pending.map((c) => c.name).join(', ');
              core.info(`Waiting for checks: ${pendingNames} (attempt ${attempt + 1}/${maxAttempts})`);
              await new Promise((resolve) => setTimeout(resolve, interval));
            }

            core.setFailed('Timeout waiting for CI checks');

      - name: Approve and Merge the PR
        if: steps.metadata.outcome == 'success' && (steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor')
        run: |
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: "${{ github.event.pull_request.html_url }}"
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
